generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String    @id @default(uuid()) @db.Uuid
  email          String    @unique
  passwordHash   String    @map("password_hash")
  firstName      String    @map("first_name")
  lastName       String    @map("last_name")
  role           UserRole
  emailVerified  Boolean   @default(false) @map("email_verified")
  organizationId String?   @map("organization_id") @db.Uuid
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  organization      Organization?      @relation(fields: [organizationId], references: [id])
  auditEvents       AuditEvent[]
  sessions          Session[]
  resetTokens       PasswordResetToken[]
  memberships       OrgMembership[]
  candidateProfile  CandidateProfile?
  jobsCreated       Job[]              @relation("JobsCreated")
  applications      Application[]      @relation("ApplicationsSubmitted")
  conversationParts ConversationParticipant[]
  messagesSent      Message[]          @relation("MessagesSent")
  meetingsRequested MeetingRequest[]   @relation("MeetingRequester")
  meetingsReceived  MeetingRequest[]   @relation("MeetingRequestee")
  scorecardsGiven   Scorecard[]        @relation("ScorecardsGiven")

  @@map("users")
}

model Organization {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  slug      String   @unique
  plan      String   @default("free")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  users       User[]
  auditEvents AuditEvent[]
  memberships OrgMembership[]
  jobs        Job[]

  @@map("organizations")
}

model Session {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  token        String   @unique
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("sessions")
}

model PasswordResetToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  token     String   @unique
  usedAt    DateTime? @map("used_at")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model OrgMembership {
  id             String        @id @default(uuid()) @db.Uuid
  userId         String        @map("user_id") @db.Uuid
  organizationId String        @map("organization_id") @db.Uuid
  role           OrgRole
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([organizationId])
  @@map("org_memberships")
}

model CandidateProfile {
  id             String   @id @default(uuid()) @db.Uuid
  userId         String   @unique @map("user_id") @db.Uuid
  headline       String?
  summary        String?
  resumeUrl      String?  @map("resume_url")
  skills         String[] @default([])
  experienceYears Int?    @map("experience_years")
  locationCity   String?  @map("location_city")
  locationState  String?  @map("location_state")
  locationCountry String? @map("location_country")
  remoteOnly     Boolean  @default(false) @map("remote_only")
  salaryMin      Int?     @map("salary_min")
  salaryMax      Int?     @map("salary_max")
  salaryCurrency String   @default("USD") @map("salary_currency")
  availableFrom  DateTime? @map("available_from")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("candidate_profiles")
}

model Job {
  id              String    @id @default(uuid()) @db.Uuid
  organizationId  String    @map("organization_id") @db.Uuid
  createdById     String    @map("created_by_id") @db.Uuid
  title           String
  description     String
  requirements    String?
  benefits        String?
  department      String?
  employmentType  EmploymentType @map("employment_type")
  experienceLevel ExperienceLevel @map("experience_level")
  locationCity    String?   @map("location_city")
  locationState   String?   @map("location_state")
  locationCountry String?   @map("location_country")
  remote          Boolean   @default(false)
  salaryMin       Int?      @map("salary_min")
  salaryMax       Int?      @map("salary_max")
  salaryCurrency  String    @default("USD") @map("salary_currency")
  skills          String[]  @default([])
  status          JobStatus @default(draft)
  publishedAt     DateTime? @map("published_at")
  closedAt        DateTime? @map("closed_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  organization    Organization @relation(fields: [organizationId], references: [id])
  createdBy       User         @relation("JobsCreated", fields: [createdById], references: [id])
  applications    Application[]

  @@index([organizationId, status])
  @@index([status, publishedAt])
  @@map("jobs")
}

model Application {
  id              String            @id @default(uuid()) @db.Uuid
  jobId           String            @map("job_id") @db.Uuid
  candidateId     String            @map("candidate_id") @db.Uuid
  coverLetter     String?           @map("cover_letter")
  resumeUrl       String?           @map("resume_url")
  stage           ApplicationStage  @default(applied)
  withdrawnAt     DateTime?         @map("withdrawn_at")
  rejectedAt      DateTime?         @map("rejected_at")
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  job             Job               @relation(fields: [jobId], references: [id])
  candidate       User              @relation("ApplicationsSubmitted", fields: [candidateId], references: [id])
  scorecards      Scorecard[]

  @@unique([jobId, candidateId])
  @@index([candidateId])
  @@index([jobId, stage])
  @@map("applications")
}

model Scorecard {
  id              String   @id @default(uuid()) @db.Uuid
  applicationId   String   @map("application_id") @db.Uuid
  reviewerId      String   @map("reviewer_id") @db.Uuid
  overallRating   Int      @map("overall_rating")
  criteria        Json
  recommendation  String?
  notes           String?
  submittedAt     DateTime @default(now()) @map("submitted_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  application     Application @relation(fields: [applicationId], references: [id])
  reviewer        User        @relation("ScorecardsGiven", fields: [reviewerId], references: [id])

  @@unique([applicationId, reviewerId])
  @@index([applicationId])
  @@map("scorecards")
}

model Conversation {
  id             String   @id @default(uuid()) @db.Uuid
  tenantId       String   @map("tenant_id") @db.Uuid
  applicationId  String?  @map("application_id") @db.Uuid
  subject        String?
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  participants   ConversationParticipant[]
  messages       Message[]

  @@index([tenantId])
  @@index([applicationId])
  @@map("conversations")
}

model ConversationParticipant {
  id              String   @id @default(uuid()) @db.Uuid
  conversationId  String   @map("conversation_id") @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  lastReadAt      DateTime? @map("last_read_at")
  createdAt       DateTime @default(now()) @map("created_at")

  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user            User         @relation(fields: [userId], references: [id])

  @@unique([conversationId, userId])
  @@index([userId])
  @@map("conversation_participants")
}

model Message {
  id              String   @id @default(uuid()) @db.Uuid
  conversationId  String   @map("conversation_id") @db.Uuid
  senderId        String   @map("sender_id") @db.Uuid
  body            String
  editedAt        DateTime? @map("edited_at")
  deletedAt       DateTime? @map("deleted_at")
  createdAt       DateTime @default(now()) @map("created_at")

  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender          User         @relation("MessagesSent", fields: [senderId], references: [id])

  @@index([conversationId, createdAt])
  @@map("messages")
}

model MeetingRequest {
  id              String        @id @default(uuid()) @db.Uuid
  tenantId        String        @map("tenant_id") @db.Uuid
  requesterId     String        @map("requester_id") @db.Uuid
  requesteeId     String        @map("requestee_id") @db.Uuid
  applicationId   String?       @map("application_id") @db.Uuid
  title           String
  description     String?
  proposedAt      DateTime      @map("proposed_at")
  durationMinutes Int           @default(30) @map("duration_minutes")
  location        String?
  meetingUrl      String?       @map("meeting_url")
  status          MeetingStatus @default(pending)
  respondedAt     DateTime?     @map("responded_at")
  cancelledAt     DateTime?     @map("cancelled_at")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  requester       User          @relation("MeetingRequester", fields: [requesterId], references: [id])
  requestee       User          @relation("MeetingRequestee", fields: [requesteeId], references: [id])

  @@index([tenantId])
  @@index([requesterId])
  @@index([requesteeId])
  @@index([status])
  @@map("meeting_requests")
}

model AuditEvent {
  id             String   @id @default(uuid()) @db.Uuid
  tenantId       String   @map("tenant_id") @db.Uuid
  actorId        String?  @map("actor_id") @db.Uuid
  action         String
  resourceType   String   @map("resource_type")
  resourceId     String?  @map("resource_id")
  metadata       Json?
  correlationId  String?  @map("correlation_id")
  ipAddress      String?  @map("ip_address")
  createdAt      DateTime @default(now()) @map("created_at")

  tenant         Organization @relation(fields: [tenantId], references: [id])
  actor          User?        @relation(fields: [actorId], references: [id])

  @@index([tenantId, createdAt])
  @@index([actorId])
  @@index([action])
  @@index([correlationId])
  @@map("audit_events")
}

model IdempotencyKey {
  id          String   @id @default(uuid()) @db.Uuid
  key         String   @unique
  response    Json?
  statusCode  Int?     @map("status_code")
  createdAt   DateTime @default(now()) @map("created_at")
  expiresAt   DateTime @map("expires_at")

  @@index([expiresAt])
  @@map("idempotency_keys")
}

enum UserRole {
  candidate
  employer
  agency
  admin

  @@map("user_role")
}

enum OrgRole {
  owner
  admin
  recruiter
  interviewer
  viewer

  @@map("org_role")
}

enum EmploymentType {
  full_time
  part_time
  contract
  internship
  temporary

  @@map("employment_type")
}

enum ExperienceLevel {
  entry
  mid
  senior
  lead
  executive

  @@map("experience_level")
}

enum JobStatus {
  draft
  published
  closed
  archived

  @@map("job_status")
}

enum ApplicationStage {
  applied
  screening
  interview
  offer
  hired
  rejected
  withdrawn

  @@map("application_stage")
}

enum MeetingStatus {
  pending
  accepted
  denied
  cancelled
  completed

  @@map("meeting_status")
}
